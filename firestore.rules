
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
  
    // Helper function to check if a user is a coach
    function isCoach(userId) {
      return get(/databases/$(database)/documents/userProfiles/$(userId)).data.role == 'coach';
    }

    // Lock down asset library to coaches only
    match /asset-library/{docId} {
        allow read: if request.auth != null;
        allow write: if isCoach(request.auth.uid);
    }

    // Coaches can manage challenges
    match /challenges/{challengeId} {
        allow read: if request.auth != null;
        allow write: if isCoach(request.auth.uid);
    }
    
    // Coaches can manage popups
    match /popups/{popupId} {
      allow read, write: if isCoach(request.auth.uid);
    }
    
    // User profiles can be read by their owner or any coach
    // They can only be created/updated by their owner.
    match /userProfiles/{userId} {
      allow read: if request.auth.uid == userId || isCoach(request.auth.uid);
      allow create, update: if request.auth.uid == userId;
    }

    // Clients collection can be read/written by coaches
    // Individual client docs can be read by their owner.
    match /clients/{clientId} {
      allow read: if request.auth.uid == clientId || isCoach(request.auth.uid);
      allow list, write: if isCoach(request.auth.uid);
      
      // All client sub-collections can be read by the owner or a coach
      // and written to by the owner. Coaches get write access via admin SDK.
      match /{collection}/{docId} {
        allow read: if request.auth.uid == clientId || isCoach(request.auth.uid);
        allow create, update, delete: if request.auth.uid == clientId;
      }
    }
    
    // Chats can only be accessed by participants of the chat
    match /chats/{chatId} {
      allow read, write: if request.auth.uid in resource.data.participants;
      
      // Messages can be created by participants, and read by them.
      match /messages/{messageId} {
        allow read, create: if request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participants;
      }
    }
  }
}
